% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/make_nested.R
\name{make_nested}
\alias{make_nested}
\title{Nest a data frame or survey object by one or more grouping variables}
\usage{
make_nested(data, group, na.rm = TRUE, sep = "_")
}
\arguments{
\item{data}{A data frame or survey design object (\code{survey.design}).}

\item{group}{One or more grouping variables. Can be supplied as bare names
(unquoted) or a character vector of column names.}

\item{na.rm}{Logical, whether to remove rows with missing values in the
grouping variables. Defaults to \code{TRUE}.}

\item{sep}{Character string used to separate levels when composing the
\code{name} column for each group. Defaults to \code{"_"}.}
}
\value{
A tibble with one row per unique combination of the grouping
variables. The tibble contains the following columns:
\itemize{
\item The grouping variables
\item \code{data}: a list-column with the subset of data or survey design for each group
\item \code{name}: a string combining the levels of the grouping variables
}
}
\description{
\code{make_nested()} creates a nested tibble where each row corresponds to a
unique combination of one or more grouping variables. The resulting tibble
contains a list-column \code{data} with the subset of the original data for
that group.

This function has S3 methods for \code{data.frame}, \code{survey.design}, and
\code{svyrep.design} objects. For more information on how this function
differs from \code{tidyr::nest()} and how it works for \code{survey.design} and
\code{svyrep.design} objects, check the details section below.
}
\details{
While \code{make_nested()} operates similarly to \code{tidyr::nest()}, there are
some important differences:
\itemize{
\item It is optimized for survey data and preserves weights, strata, and PSU
information when nesting \code{survey.design} objects and replication
weights when nesting \code{svyrep.design} objects.
\item It uses \code{vctrs::vec_split()} for faster grouping.
\item The output always contains a \code{name} column that concatenates the levels
of the grouping variables, which is useful for labeling and further
analysis.
\item Unlike \code{tidyr::nest()}, you cannot control which columns go into the
inner list-column; the inner data frames always include all columns
not used for grouping.
\item Unlike \code{tidyr::nest()} where \code{.by} supersedes any \code{dplyr::group_by()}
grouping, \code{make_nested()} combines any existing \code{dplyr::group_by()}
variables with the supplied \code{group} argument when nesting.
}

When nesting a \code{survey.design} object, each nested group is subsetted and
converted into a new \code{survey.design} object using \code{srvyr::as_survey_rep}.
The \code{.data}, \code{ids}, \code{strata}, \code{weights}, \code{fpc}, and \code{nest} arguments are
specified.

\strong{Note:} If a nested group contains only one primary sampling unit
(PSU), \code{svydesign()} cannot compute variance estimates and the function
will fail for that group. This is most likely to occur with small
datasets, highly granular grouping variables, or a small number of PSUs
per stratum. For typical survey datasets with sufficient PSUs, this is
unlikely to occur.

When nesting a \code{svyrep.design} object, each nested group is subsetted and
converted into a new \code{svyrep.design} object using
\code{srvyr::as_survey_rep()}.

\strong{Note:} The finite population corrections
(\code{fpc}) are not carried over when
}
\examples{
# Example with a data frame
df <- make_basic_df()
nested_df <- make_nested(df, grp)

# Nested by multiple variables
nested_df2 <- make_nested(df, c(grp, x2))

# Example with a survey.design object
library(survey)
design <- svydesign(
  ids = ~psu,
  strata = ~strata,
  weights = ~wts,
  data = df,
  fpc = ~fpc_psu
)
nested_svy <- make_nested(design, grp)

}
